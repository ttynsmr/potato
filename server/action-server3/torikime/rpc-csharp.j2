// Generated by the torikime.  DO NOT EDIT!
using System;
using System.Collections;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace {{ namespace | camelize }}
{
    using OnSubscribeRequestDelegate = Action<Google.Protobuf.IMessage>;

    namespace {{ contract | camelize }}
    {
        namespace {{ name | camelize }}
        {
            public class Rpc : {{ namespace | camelize }}.IRpc
            {
                public static uint StaticContractId = {{ contract_id }};
                public static uint StaticRpcId = {{ rpc_id }};

                public uint ContractId => StaticContractId;
                public uint RpcId => StaticRpcId;

                private Potato.Network.Session session;
                public Rpc(Potato.Network.Session session)
                {
                    this.session = session;
                }

                private OnSubscribeRequestDelegate onSubscribeRequest;
                public void SubscribeRequest(OnSubscribeRequestDelegate callback)
                {
                    onSubscribeRequest = callback;
                }

                public Google.Protobuf.IMessage ReceievePayload(Potato.Network.Protocol.Payload payload)
                {
                    switch (payload.Header.RpcId)
                    {
                        case {{ rpc_id }}:
                            switch (payload.Header.Meta)
                            {
{%- if "request" in rpc %}
                                case Meta.Response:
                                    return on{{ name | camelize }}Response(payload);
{% endif %}
{% if "notification" in rpc %}
                                case Meta.Notification:
                                    return on{{ name | camelize }}Notification(payload);
{% endif %}
                                default:
                                    return null;
                            }
                        default:
                            return null;
                    }
                }

{%- if "request" in rpc %}
                public delegate void ResponseCallback(Response response);
                private Dictionary<uint, Action<Response>> responseCallbacks = new Dictionary<uint, Action<Response>>();
                private uint requestId = 0;
                public void Request(Request request, ResponseCallback callback)
                {
                    RequestParcel parcel = new RequestParcel();
                    parcel.RequestId = ++requestId;
                    parcel.Request = request;

                    responseCallbacks.Add(parcel.RequestId, (response) => { callback(response); });

                    using (System.IO.MemoryStream ms = new System.IO.MemoryStream())
                    using (Google.Protobuf.CodedOutputStream output = new Google.Protobuf.CodedOutputStream(ms))
                    {
                        PayloadHeader header = new PayloadHeader {
                            ContractId = ContractId,
                            RpcId = RpcId,
                            Meta = Meta.Request,
                            PayloadSize = parcel.CalculateSize(),
                        };

                        Potato.Network.Protocol.Payload payload = new Potato.Network.Protocol.Payload(header);
                        parcel.WriteTo(output);
                        output.Flush();
                        ms.Position = 0;
                        ms.Read(payload.GetBuffer(), 0, (int)ms.Length);
                        session.SendPayload(payload);
                    }

                    onSubscribeRequest?.Invoke(request);
                }

                public IEnumerator RequestCoroutine(Request request, ResponseCallback callback)
                {
                    bool wait = true;
                    Request(request, (response) => {
                        wait = false;
                        callback(response);
                    });

                    while (wait)
                    {
                        yield return null;
                    }
                }

                {# public async Task<Response> RequestAsync(Request request)
                {
                    RequestParcel parcel = new RequestParcel();
                    parcel.RequestId = ++requestId;
                    parcel.Request = request;

                    responseCallbacks.Add(parcel.RequestId, callback);
                    await Task.Delay(1000);
                    return new Response();
                } #}

                private Google.Protobuf.IMessage on{{ name | camelize }}Response(Potato.Network.Protocol.Payload payload)
                {
                    ResponseParcel responseParcel = new ResponseParcel();
                    responseParcel.MergeFrom(new Google.Protobuf.CodedInputStream(payload.GetBuffer(), 0, payload.GetBuffer().Length));

                    if (responseCallbacks.TryGetValue(responseParcel.RequestId, out var callback))
                    {
                        try
                        {
                            callback(responseParcel.Response);
                        }
                        catch (Exception)
                        {
                        }
                        responseCallbacks.Remove(responseParcel.RequestId);
                    }

                    return responseParcel.Response;
                }
{% endif %}

{% if "notification" in rpc %}
                public event Action<Notification> OnNotification;
                private Google.Protobuf.IMessage on{{ name | camelize }}Notification(Potato.Network.Protocol.Payload payload)
                {
                    NotificationParcel notificationParcel = new NotificationParcel();
                    notificationParcel.MergeFrom(new Google.Protobuf.CodedInputStream(payload.GetBuffer(), 0, payload.GetBuffer().Length));
                    try
                    {
                        OnNotification?.Invoke(notificationParcel.Notification);
                    }
                    catch (Exception)
                    {
                    }
                    return notificationParcel.Notification;
                }
{% endif %}
            }
        }
    }
}
