file(GLOB_RECURSE RPC_SOURCES RELATIVE "${CMAKE_CURRENT_SOURCE_DIR}" CONFIGURE_DEPENDS "*.yaml")
message("RPC_SOURCES: ${RPC_SOURCES}")

execute_process(
  COMMAND pipenv sync
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/../torikime
)
execute_process(
  COMMAND pipenv run ${CMAKE_CURRENT_SOURCE_DIR}/../torikime/torikime.py -v -o ${CMAKE_CURRENT_BINARY_DIR}/../proto -c "${CMAKE_CURRENT_BINARY_DIR}/generated" -i ${CMAKE_CURRENT_SOURCE_DIR} --cache_dir ${CMAKE_CURRENT_BINARY_DIR}/torikime
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/../torikime
)

file(GLOB_RECURSE SOURCE_PROTO_FILES CONFIGURE_DEPENDS "${CMAKE_SOURCE_DIR}/proto/*.proto")
message("SOURCE_PROTO_FILES: ${SOURCE_PROTO_FILES}")

file(GLOB_RECURSE SOURCE_PROTO_FILES CONFIGURE_DEPENDS "${CMAKE_BINARY_DIR}/proto/*.proto")
message("GENERATED_PROTO_FILES: ${GENERATED_PROTO_FILES}")

list(REMOVE_ITEM GENERATED_PROTO_FILES "")
list(APPEND GENERATED_PROTO_FILES ${SOURCE_PROTO_FILES})

add_custom_target(rpc_generate
  COMMAND pipenv sync
  COMMAND pipenv run ${CMAKE_CURRENT_SOURCE_DIR}/../torikime/torikime.py -v -o ${CMAKE_CURRENT_BINARY_DIR}/../proto -c "${CMAKE_CURRENT_BINARY_DIR}/generated" -i ${CMAKE_CURRENT_SOURCE_DIR} --cache_dir ${CMAKE_CURRENT_BINARY_DIR}/torikime
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/../torikime
  DEPENDS ${RPC_SOURCES}
  COMMAND find ${CMAKE_CURRENT_SOURCE_DIR} -type f -name '*.yaml' | sort | xargs sha1sum | sha1sum > "${CMAKE_CURRENT_BINARY_DIR}/rpc.hash"
)

message("rpc.CMAKE_CURRENT_BINARY_DIR: ${CMAKE_CURRENT_BINARY_DIR}")
message("GENERATED_PROTO_FILES: ${GENERATED_PROTO_FILES}")
set(GENERATED_PROTO_FILES ${GENERATED_PROTO_FILES} PARENT_SCOPE)
